{% extends "base.html" %}
{% block title %}agentgw - Documents{% endblock %}

{% block content %}
<h1>Knowledge Base Documents</h1>

<section class="card">
    <h2>Search & Filter</h2>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
        <div class="form-group" style="flex: 1; min-width: 200px;">
            <label for="filter-source">Source (contains)</label>
            <input type="text" id="filter-source" placeholder="e.g., python-guide">
        </div>
        <div class="form-group" style="flex: 1; min-width: 200px;">
            <label for="filter-skills">Skills (comma-separated)</label>
            <input type="text" id="filter-skills" placeholder="e.g., code_assistant">
        </div>
        <div class="form-group" style="flex: 1; min-width: 200px;">
            <label for="filter-collection">Collection</label>
            <input type="text" id="filter-collection" value="default">
        </div>
        <div class="form-group" style="flex: 1; min-width: 150px;">
            <label for="filter-limit">Limit</label>
            <input type="number" id="filter-limit" value="100" min="1" max="1000">
        </div>
    </div>
    <button onclick="loadDocuments()">Search</button>
    <button onclick="clearFilters()" style="background: #565f89;">Clear Filters</button>
</section>

<section class="card">
    <h2>Documents <span id="doc-count" style="color: #7aa2f7;"></span></h2>
    <div id="documents-list"></div>
</section>

<div id="delete-modal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: #1a1b26; padding: 2rem; border-radius: 8px; max-width: 500px; margin: 2rem;">
        <h3>Confirm Deletion</h3>
        <p id="delete-confirm-text"></p>
        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
            <button onclick="confirmDelete()" style="background: #f7768e;">Delete</button>
            <button onclick="closeDeleteModal()" style="background: #565f89;">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentDeleteAction = null;

async function loadDocuments() {
    const source = document.getElementById('filter-source').value.trim();
    const skillsStr = document.getElementById('filter-skills').value.trim();
    const collection = document.getElementById('filter-collection').value.trim() || 'default';
    const limit = document.getElementById('filter-limit').value;

    const params = new URLSearchParams({ collection, limit });
    if (source) params.append('source', source);
    if (skillsStr) params.append('skills', skillsStr);

    try {
        const resp = await fetch(`/api/documents?${params}`);
        const data = await resp.json();
        displayDocuments(data.documents, data.count);
    } catch (err) {
        document.getElementById('documents-list').innerHTML = `<p style="color: #f7768e;">Error: ${err.message}</p>`;
    }
}

function displayDocuments(docs, count) {
    const list = document.getElementById('documents-list');
    document.getElementById('doc-count').textContent = `(${count} found)`;

    if (docs.length === 0) {
        list.innerHTML = '<p style="color: #565f89;">No documents found. Try adjusting your filters or <a href="/ingest">ingest some documents</a>.</p>';
        return;
    }

    let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';

    // Group by source
    const bySource = {};
    docs.forEach(doc => {
        const src = doc.metadata.source || 'unknown';
        if (!bySource[src]) bySource[src] = [];
        bySource[src].push(doc);
    });

    for (const [source, sourceDocs] of Object.entries(bySource)) {
        const firstDoc = sourceDocs[0];
        const skills = firstDoc.metadata.skills || '';
        const tags = firstDoc.metadata.tags || '';
        const totalChunks = firstDoc.metadata.total_chunks || 1;

        html += `
        <div style="border: 1px solid #414868; border-radius: 4px; padding: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                <div>
                    <strong style="color: #7dcfff;">${escapeHtml(source)}</strong>
                    <span style="color: #565f89; margin-left: 0.5rem;">${totalChunks} chunk(s)</span>
                </div>
                <button onclick="deleteBySource('${escapeHtml(source)}')" style="background: #f7768e; padding: 0.25rem 0.75rem; font-size: 0.9rem;">Delete All</button>
            </div>
            <div style="margin-bottom: 0.5rem;">
                ${skills ? `<span style="background: #7aa2f7; color: #1a1b26; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.85rem; margin-right: 0.5rem;">Skills: ${escapeHtml(skills)}</span>` : '<span style="color: #565f89; font-size: 0.85rem;">Available to all skills</span>'}
                ${tags ? `<span style="background: #9ece6a; color: #1a1b26; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.85rem;">Tags: ${escapeHtml(tags)}</span>` : ''}
            </div>
            <details style="margin-top: 0.5rem;">
                <summary style="cursor: pointer; color: #7aa2f7;">View ${sourceDocs.length} chunk(s)</summary>
                <div style="margin-top: 0.5rem; margin-left: 1rem;">
        `;

        sourceDocs.forEach(doc => {
            const chunkIdx = (doc.metadata.chunk_index || 0) + 1;
            html += `
                <div style="border-left: 2px solid #414868; padding-left: 0.5rem; margin-bottom: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #565f89; font-size: 0.85rem;">Chunk ${chunkIdx}</span>
                        <button onclick="deleteById('${doc.id}')" style="background: #565f89; padding: 0.15rem 0.5rem; font-size: 0.8rem;">Delete</button>
                    </div>
                    <div style="color: #c0caf5; font-size: 0.9rem; margin-top: 0.25rem; font-family: monospace; white-space: pre-wrap;">${escapeHtml(doc.text)}</div>
                    <div style="color: #414868; font-size: 0.75rem; margin-top: 0.25rem;">ID: ${doc.id}</div>
                </div>
            `;
        });

        html += `
                </div>
            </details>
        </div>
        `;
    }

    html += '</div>';
    list.innerHTML = html;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function deleteBySource(source) {
    currentDeleteAction = { type: 'source', value: source };
    document.getElementById('delete-confirm-text').innerHTML =
        `Delete all chunks from source <strong>${escapeHtml(source)}</strong>?<br><br>This action cannot be undone.`;
    document.getElementById('delete-modal').style.display = 'flex';
}

function deleteById(id) {
    currentDeleteAction = { type: 'id', value: id };
    document.getElementById('delete-confirm-text').innerHTML =
        `Delete this chunk?<br><br>ID: ${escapeHtml(id)}<br><br>This action cannot be undone.`;
    document.getElementById('delete-modal').style.display = 'flex';
}

function closeDeleteModal() {
    document.getElementById('delete-modal').style.display = 'none';
    currentDeleteAction = null;
}

async function confirmDelete() {
    if (!currentDeleteAction) return;

    const collection = document.getElementById('filter-collection').value.trim() || 'default';
    const params = new URLSearchParams({ collection });

    if (currentDeleteAction.type === 'source') {
        params.append('source', currentDeleteAction.value);
    } else {
        params.append('ids', currentDeleteAction.value);
    }

    try {
        const resp = await fetch(`/api/documents?${params}`, { method: 'DELETE' });
        const data = await resp.json();

        if (data.status === 'ok') {
            closeDeleteModal();
            loadDocuments(); // Reload the list
            showToast(`Deleted ${data.deleted} document(s)`, 'success');
        } else {
            showToast(`Error: ${data.message}`, 'error');
        }
    } catch (err) {
        showToast(`Error: ${err.message}`, 'error');
    }
}

function clearFilters() {
    document.getElementById('filter-source').value = '';
    document.getElementById('filter-skills').value = '';
    document.getElementById('filter-collection').value = 'default';
    document.getElementById('filter-limit').value = '100';
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 9999;
        padding: 1rem 1.5rem; border-radius: 4px;
        background: ${type === 'success' ? '#9ece6a' : '#f7768e'};
        color: #1a1b26; font-weight: 500;
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Load documents on page load
window.addEventListener('DOMContentLoaded', () => loadDocuments());
</script>
{% endblock %}
